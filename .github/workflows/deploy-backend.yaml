name: Deploy Backend
on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yaml"

permissions:
  contents: read

env:
  EC2_INSTANCE: ${{ secrets.EC2_INSTANCE }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    environment:
      name: prod
      url: ${{ steps.deploy.outputs.vm_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create directory on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@$EC2_INSTANCE << 'EOF'
          sudo rm -rf /home/ec2-user/api
          sudo mkdir -p /home/ec2-user/api
          sudo chown ec2-user:ec2-user /home/ec2-user/api
          EOF

      - name: Copy files to EC2
        run: |
          scp -o StrictHostKeyChecking=no -r * ec2-user@$EC2_INSTANCE:/home/ec2-user/api/
      
      - name: Deploy Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@$EC2_INSTANCE << 'EOF'
          set -euo pipefail

          # --- Docker engine & compose plugin ---
          sudo yum update -y
          sudo amazon-linux-extras install docker -y || true
          sudo systemctl enable docker
          sudo systemctl start docker
          sudo usermod -aG docker ec2-user

          # Compose v2 plugin (idempotent)
          sudo mkdir -p /usr/local/lib/docker/cli-plugins
          curl -fsSL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-$(uname -m)" \
            | sudo tee /usr/local/lib/docker/cli-plugins/docker-compose >/dev/null
          sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

          # --- Buildx + BuildKit ---
          # deps for JSON parsing
          sudo yum install -y jq

          # Map kernel arch to release arch names
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64) ARCH="amd64" ;;
            aarch64) ARCH="arm64" ;;
          esac

          # Find latest Buildx version and download correct asset
          BUILDX_VERSION="$(curl -fsSL https://api.github.com/repos/docker/buildx/releases/latest | jq -r .tag_name)"
          BUILDX_URL="https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-${ARCH}"

          sudo mkdir -p /usr/local/lib/docker/cli-plugins
          curl -fsSL "$BUILDX_URL" \
            | sudo tee /usr/local/lib/docker/cli-plugins/docker-buildx >/dev/null || {
              echo "Falling back to a pinned version..."
              BUILDX_VERSION="v0.16.2"
              BUILDX_URL="https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-${ARCH}"
              curl -fsSL "$BUILDX_URL" \
                | sudo tee /usr/local/lib/docker/cli-plugins/docker-buildx >/dev/null
            }
          sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-buildx

          # Enable BuildKit in Docker daemon
          echo '{"features":{"buildkit": true}}' | sudo tee /etc/docker/daemon.json >/dev/null
          sudo systemctl restart docker

          # Initialize/activate a Buildx builder
          docker buildx version || true
          docker buildx create --name ec2builder --use >/dev/null 2>&1 || docker buildx use ec2builder
          docker buildx inspect --bootstrap >/dev/null

          # --- Deploy app ---
          cd /home/ec2-user/api
          echo "${{ secrets.DOT_ENV }}" > .env

          docker compose build
          docker compose down || true
          docker compose up -d
          EOF
